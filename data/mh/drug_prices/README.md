# Ministry of Health Drug Prices

This directory contains derived datasets generated by `scripts/generate_drug_prices.py` from the Ministry of Health `drug-prices-*.xlsx` workbooks. Only the columns that are visible inside the spreadsheets are imported so the JSON mirrors what analysts see in Excel.

## `records.json`
- **Type:** Object  
- **Fields:**
  - `generated_at` (`string`): ISO-8601 timestamp (UTC) when the export was produced.
  - `records` (`array`): Product-level entries containing the latest visible prices as well as their version history.
    - Base metadata (`string` unless noted):
      - `serial_number` (`number` | `null`), `product_name`, `active_substance`, `atc_code`, `dose`, `pharmaceutical_form`, `packaging`, `marketing_authorisation_holder`, `manufacturer`, `authorization_number`.
    - Latest price snapshot (`number` values rounded to 2 decimals):
      - `price_wholesale`, `price_with_margin`, `price_retail`, `valid_until` (`string`).
      - Optional `reference_prices` / `reference_prices_secondary` (`object`): Regional comparison prices keyed by `macedonia`, `montenegro`, `croatia`, `slovenia`, `bulgaria`, `estonia`, `other`.  
        (The Excel “MARZHA” column is omitted because the margin can be obtained via `price_retail - price_wholesale`.)
    - Version metadata:
      - `latest_version` (`string`): Version identifier (e.g., `1.10`) where the top-level prices originate.
      - `version_history` (`array`): Snapshots ordered from newest to oldest. Each snapshot contains `version`, `price_wholesale`, `price_with_margin`, `price_retail`, `valid_until`, and optional `reference_prices` maps.

### Sample record
```json
{
  "serial_number": 2641,
  "product_name": "3BE",
  "active_substance": "THIAMINE HYDROCHLORIDE, PYRIDOXINE HYDROCHLORIDE, CYANOCOBALAMINE*",
  "atc_code": "A11DB",
  "dose": "250+250+1 MG/TAB",
  "pharmaceutical_form": "Film coated tablet",
  "packaging": "PVC/PVDC/ALUMINIUM FOIL, CARDBOARD BOX x 30 tablets",
  "marketing_authorisation_holder": "Medicair Bioscience Laboratories S.A.Greece",
  "manufacturer": "MEDICAIR BIOSCIENCE LABORATORIES S.A., Greece",
  "authorization_number": "MA-08272/15/05/2024",
  "price_wholesale": 11.16,
  "price_with_margin": 13.057,
  "price_retail": 14.102,
  "valid_until": "2026-01-31",
  "latest_version": "1.10",
  "version_history": [
    {
      "version": "1.10",
      "price_wholesale": 11.16,
      "price_with_margin": 13.057,
      "price_retail": 14.102,
      "valid_until": "2026-01-31"
    },
    {
      "version": "1.9",
      "price_wholesale": 11.16,
      "price_with_margin": 13.057,
      "price_retail": 14.102,
      "valid_until": "2026-01-31"
    }
  ]
}
```

## `versions.json`
- **Type:** Object  
- **Fields:**
  - `generated_at` (`string`): UTC timestamp matching `records.json`.
  - `versions` (`array`): One entry per Excel workbook processed.
    - `version` (`string`): Version identifier extracted from filename.
    - `source_file` (`string`): Relative path to the workbook.
    - `record_count` (`number`): Number of product rows retained after cleaning.
    - `valid_until_values` (`array<string>`): Distinct validity values present in that workbook.

### Sample version entry
```json
{
  "version": "1.10",
  "source_file": "raw_data/drug-prices-1.10.xlsx",
  "record_count": 4087,
  "valid_until_values": [
    "2026-01-31"
  ]
}
```

## Regeneration

```bash
python scripts/generate_drug_prices.py \
  --source raw_data \
  --pattern "drug-prices-*.xlsx" \
  --output data/mh/drug_prices
```

The script:
1. Discovers Excel workbooks matching the pattern.
2. Reads only the columns that are visible (hidden Excel columns are skipped).
3. Drops records without a product name.
4. Normalises numeric values (rounded to 2 decimals), trims strings, converts validity dates to ISO format, aggregates records by product to surface the most recent wholesale/retail prices at the top level, attaches a `version_history` of past prices, and writes the JSON files above.

Any new workbook dropped into `raw_data` with the matching filename format can be included by re-running the generator.
